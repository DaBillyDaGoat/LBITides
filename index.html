<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LBI Tides ‚Äî Long Beach Island</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --ocean: #0a3d5c;
    --deep: #061f30;
    --sky: #d4eaf7;
    --sand: #e8d5b0;
    --foam: #f0f8ff;
    --accent: #f4a32a;
    --text: #0d1f2d;
    --muted: #5a7a8a;
    --card: rgba(255,255,255,0.85);
    --high-tide: #0a3d5c;
    --low-tide: #7ec8e3;
  }

- { margin: 0; padding: 0; box-sizing: border-box; }

body {
font-family: ‚ÄòDM Sans‚Äô, sans-serif;
background: var(‚Äìdeep);
color: var(‚Äìtext);
min-height: 100vh;
overflow-x: hidden;
}

/* HERO / HEADER */
header {
position: relative;
background: linear-gradient(180deg, #061f30 0%, #0a3d5c 60%, #1a6e8a 100%);
padding: 2rem 1.5rem 4rem;
text-align: center;
overflow: hidden;
}

header::before {
content: ‚Äò‚Äô;
position: absolute;
bottom: 0; left: 0; right: 0;
height: 80px;
background: url(‚Äúdata:image/svg+xml,%3Csvg xmlns=‚Äòhttp://www.w3.org/2000/svg‚Äô viewBox=‚Äò0 0 1440 80‚Äô%3E%3Cpath fill=‚Äô%23f5f0e8‚Äô d=‚ÄòM0,40 C360,80 1080,0 1440,40 L1440,80 L0,80 Z‚Äô/%3E%3C/svg%3E‚Äù) no-repeat bottom;
background-size: cover;
}

.stars {
position: absolute;
top: 0; left: 0; right: 0; bottom: 0;
background-image:
radial-gradient(1px 1px at 20% 15%, rgba(255,255,255,0.6) 0%, transparent 100%),
radial-gradient(1px 1px at 75% 10%, rgba(255,255,255,0.4) 0%, transparent 100%),
radial-gradient(1.5px 1.5px at 45% 25%, rgba(255,255,255,0.5) 0%, transparent 100%),
radial-gradient(1px 1px at 85% 30%, rgba(255,255,255,0.3) 0%, transparent 100%),
radial-gradient(1px 1px at 10% 40%, rgba(255,255,255,0.4) 0%, transparent 100%);
}

.site-title {
font-family: ‚ÄòPlayfair Display‚Äô, serif;
font-size: clamp(2.2rem, 6vw, 3.5rem);
color: #fff;
letter-spacing: 0.02em;
position: relative;
z-index: 1;
}

.site-subtitle {
color: rgba(212, 234, 247, 0.8);
font-size: 0.9rem;
font-weight: 300;
letter-spacing: 0.2em;
text-transform: uppercase;
margin-top: 0.4rem;
position: relative;
z-index: 1;
}

#current-date {
color: var(‚Äìaccent);
font-size: 0.85rem;
font-weight: 500;
margin-top: 1rem;
letter-spacing: 0.1em;
text-transform: uppercase;
position: relative;
z-index: 1;
}

/* MAIN CONTENT */
main {
background: #f5f0e8;
padding: 2rem 1rem 4rem;
max-width: 900px;
margin: 0 auto;
}

/* AD PLACEHOLDER */
.ad-unit {
background: rgba(0,0,0,0.05);
border: 1px dashed rgba(0,0,0,0.15);
border-radius: 8px;
text-align: center;
padding: 1rem;
color: var(‚Äìmuted);
font-size: 0.75rem;
letter-spacing: 0.1em;
text-transform: uppercase;
margin-bottom: 1.5rem;
}

.ad-unit.leaderboard { height: 90px; display: flex; align-items: center; justify-content: center; }
.ad-unit.square { min-height: 250px; display: flex; align-items: center; justify-content: center; }

/* CARDS */
.card {
background: var(‚Äìcard);
border-radius: 16px;
padding: 1.5rem;
margin-bottom: 1.25rem;
box-shadow: 0 2px 20px rgba(0,0,0,0.07);
backdrop-filter: blur(10px);
}

.card-title {
font-family: ‚ÄòPlayfair Display‚Äô, serif;
font-size: 1.1rem;
color: var(‚Äìocean);
margin-bottom: 1rem;
display: flex;
align-items: center;
gap: 0.5rem;
}

.card-title .icon { font-size: 1.2rem; }

/* TIDE SUMMARY PILLS */
.tide-pills {
display: flex;
flex-wrap: wrap;
gap: 0.75rem;
margin-bottom: 1rem;
}

.tide-pill {
flex: 1;
min-width: 120px;
background: linear-gradient(135deg, var(‚Äìocean), #1a6e8a);
color: white;
border-radius: 12px;
padding: 0.9rem 1rem;
text-align: center;
}

.tide-pill.low {
background: linear-gradient(135deg, #4a9bb5, #7ec8e3);
color: var(‚Äìdeep);
}

.tide-pill .label {
font-size: 0.65rem;
letter-spacing: 0.15em;
text-transform: uppercase;
opacity: 0.8;
margin-bottom: 0.2rem;
}

.tide-pill .time {
font-family: ‚ÄòPlayfair Display‚Äô, serif;
font-size: 1.3rem;
font-weight: 700;
}

.tide-pill .height {
font-size: 0.75rem;
opacity: 0.85;
}

/* TIDE CHART */
.tide-chart-wrap {
position: relative;
height: 120px;
margin: 1rem 0 0.5rem;
}

canvas#tideChart {
width: 100%;
height: 120px;
border-radius: 8px;
}

.chart-labels {
display: flex;
justify-content: space-between;
font-size: 0.65rem;
color: var(‚Äìmuted);
margin-top: 0.25rem;
letter-spacing: 0.05em;
}

/* STATS GRID */
.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
gap: 0.75rem;
}

.stat-block {
background: rgba(10, 61, 92, 0.06);
border-radius: 12px;
padding: 0.9rem;
text-align: center;
}

.stat-block .stat-icon { font-size: 1.4rem; margin-bottom: 0.25rem; }
.stat-block .stat-label {
font-size: 0.6rem;
letter-spacing: 0.15em;
text-transform: uppercase;
color: var(‚Äìmuted);
margin-bottom: 0.2rem;
}
.stat-block .stat-value {
font-family: ‚ÄòPlayfair Display‚Äô, serif;
font-size: 1.25rem;
color: var(‚Äìocean);
}
.stat-block .stat-unit {
font-size: 0.65rem;
color: var(‚Äìmuted);
}

/* MOON */
.moon-display {
display: flex;
align-items: center;
gap: 1.5rem;
}

.moon-icon {
font-size: 3.5rem;
line-height: 1;
}

.moon-info .phase-name {
font-family: ‚ÄòPlayfair Display‚Äô, serif;
font-size: 1.2rem;
color: var(‚Äìocean);
}

.moon-info .moon-detail {
font-size: 0.8rem;
color: var(‚Äìmuted);
margin-top: 0.2rem;
}

.moon-bar-wrap {
flex: 1;
}

.moon-bar-label {
font-size: 0.65rem;
letter-spacing: 0.1em;
text-transform: uppercase;
color: var(‚Äìmuted);
margin-bottom: 0.4rem;
}

.moon-bar {
height: 6px;
background: rgba(0,0,0,0.1);
border-radius: 999px;
overflow: hidden;
}

.moon-bar-fill {
height: 100%;
background: linear-gradient(90deg, var(‚Äìaccent), #ffd700);
border-radius: 999px;
transition: width 1s ease;
}

/* 7-DAY FORECAST */
.forecast-row {
display: flex;
gap: 0.5rem;
overflow-x: auto;
padding-bottom: 0.5rem;
scrollbar-width: thin;
}

.forecast-day {
flex: 0 0 auto;
background: rgba(10, 61, 92, 0.06);
border-radius: 10px;
padding: 0.75rem 0.6rem;
text-align: center;
min-width: 80px;
}

.forecast-day.today {
background: linear-gradient(135deg, var(‚Äìocean), #1a6e8a);
color: white;
}

.forecast-day .day-name {
font-size: 0.65rem;
letter-spacing: 0.1em;
text-transform: uppercase;
margin-bottom: 0.4rem;
opacity: 0.7;
}

.forecast-day .day-high {
font-family: ‚ÄòPlayfair Display‚Äô, serif;
font-size: 1rem;
color: inherit;
}

.forecast-day .day-low {
font-size: 0.75rem;
opacity: 0.6;
margin-top: 0.15rem;
}

.forecast-day .day-wave {
font-size: 0.7rem;
margin-top: 0.4rem;
opacity: 0.75;
}

/* SMART SUMMARY */
.summary-box {
background: linear-gradient(135deg, var(‚Äìocean) 0%, #1a5c78 100%);
border-radius: 16px;
padding: 1.5rem;
color: white;
margin-bottom: 1.25rem;
}

.summary-box .summary-title {
font-size: 0.65rem;
letter-spacing: 0.2em;
text-transform: uppercase;
color: rgba(212,234,247,0.7);
margin-bottom: 0.5rem;
}

.summary-box .summary-text {
font-family: ‚ÄòPlayfair Display‚Äô, serif;
font-size: 1.05rem;
line-height: 1.6;
color: #e8f4fd;
}

.summary-tags {
display: flex;
flex-wrap: wrap;
gap: 0.4rem;
margin-top: 0.75rem;
}

.tag {
background: rgba(255,255,255,0.15);
border-radius: 999px;
padding: 0.2rem 0.6rem;
font-size: 0.7rem;
letter-spacing: 0.05em;
}

/* AFFILIATE */
.affiliate-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
gap: 0.75rem;
}

.affiliate-item {
background: rgba(10, 61, 92, 0.06);
border-radius: 12px;
padding: 1rem;
text-align: center;
text-decoration: none;
color: var(‚Äìtext);
transition: transform 0.2s, box-shadow 0.2s;
}

.affiliate-item:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}

.affiliate-item .aff-icon { font-size: 1.8rem; margin-bottom: 0.4rem; }
.affiliate-item .aff-label { font-size: 0.8rem; font-weight: 500; color: var(‚Äìocean); }
.affiliate-item .aff-sub { font-size: 0.7rem; color: var(‚Äìmuted); margin-top: 0.15rem; }

/* FOOTER */
footer {
background: var(‚Äìdeep);
color: rgba(255,255,255,0.4);
text-align: center;
padding: 2rem 1rem;
font-size: 0.75rem;
letter-spacing: 0.05em;
}

footer a { color: rgba(255,255,255,0.5); text-decoration: none; }

/* LOADING */
.loading {
text-align: center;
color: var(‚Äìmuted);
font-size: 0.85rem;
padding: 1rem;
animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* FADE IN */
.fade-in {
opacity: 0;
transform: translateY(12px);
transition: opacity 0.5s ease, transform 0.5s ease;
}
.fade-in.visible { opacity: 1; transform: translateY(0); }

@media (max-width: 500px) {
.moon-display { flex-direction: column; align-items: flex-start; }
.moon-bar-wrap { width: 100%; }
}
</style>

</head>
<body>

<header>
  <div class="stars"></div>
  <div class="site-title">LBI Tides</div>
  <div class="site-subtitle">Long Beach Island, New Jersey</div>
  <div id="current-date">Loading...</div>
</header>

<main>

  <!-- TOP AD -->

  <div class="ad-unit leaderboard">
    <!-- AdSense leaderboard 728x90 goes here -->
    Advertisement
  </div>

  <!-- SMART SUMMARY -->

  <div class="summary-box fade-in" id="summaryBox">
    <div class="summary-title">Today's Conditions at a Glance</div>
    <div class="summary-text" id="summaryText">Loading today's summary...</div>
    <div class="summary-tags" id="summaryTags"></div>
  </div>

  <!-- TIDES -->

  <div class="card fade-in">
    <div class="card-title"><span class="icon">üåä</span> Today's Tides</div>
    <div class="tide-pills" id="tidePills">
      <div class="loading">Fetching tide data...</div>
    </div>
    <div class="tide-chart-wrap">
      <canvas id="tideChart"></canvas>
    </div>
    <div class="chart-labels">
      <span>12am</span><span>6am</span><span>12pm</span><span>6pm</span><span>11pm</span>
    </div>
  </div>

  <!-- WEATHER + WAVES -->

  <div class="card fade-in">
    <div class="card-title"><span class="icon">‚òÄÔ∏è</span> Weather & Ocean</div>
    <div class="stats-grid" id="weatherStats">
      <div class="loading">Fetching conditions...</div>
    </div>
  </div>

  <!-- MOON -->

  <div class="card fade-in">
    <div class="card-title"><span class="icon">üåô</span> Moon Phase</div>
    <div class="moon-display" id="moonDisplay">
      <div class="loading">Fetching moon data...</div>
    </div>
  </div>

  <!-- MID AD -->

  <div class="ad-unit square">
    <!-- AdSense 300x250 rectangle goes here -->
    Advertisement
  </div>

  <!-- 7-DAY FORECAST -->

  <div class="card fade-in">
    <div class="card-title"><span class="icon">üìÖ</span> 7-Day Forecast</div>
    <div class="forecast-row" id="forecastRow">
      <div class="loading">Loading forecast...</div>
    </div>
  </div>

  <!-- AFFILIATE LINKS -->

  <div class="card fade-in">
    <div class="card-title"><span class="icon">üé£</span> LBI Essentials</div>
    <div class="affiliate-grid">
      <a href="https://www.amazon.com/s?k=surf+fishing+rods&tag=YOURTAG" class="affiliate-item" target="_blank">
        <div class="aff-icon">üé£</div>
        <div class="aff-label">Fishing Gear</div>
        <div class="aff-sub">Rods, reels & tackle</div>
      </a>
      <a href="https://www.amazon.com/s?k=surfboard&tag=YOURTAG" class="affiliate-item" target="_blank">
        <div class="aff-icon">üèÑ</div>
        <div class="aff-label">Surf Gear</div>
        <div class="aff-sub">Boards & wetsuits</div>
      </a>
      <a href="https://www.amazon.com/s?k=beach+chairs+umbrella&tag=YOURTAG" class="affiliate-item" target="_blank">
        <div class="aff-icon">‚õ±Ô∏è</div>
        <div class="aff-label">Beach Gear</div>
        <div class="aff-sub">Chairs, umbrellas & more</div>
      </a>
      <a href="https://www.amazon.com/s?k=kayak&tag=YOURTAG" class="affiliate-item" target="_blank">
        <div class="aff-icon">üö£</div>
        <div class="aff-label">Water Sports</div>
        <div class="aff-sub">Kayaks & paddleboards</div>
      </a>
    </div>
  </div>

</main>

<footer>
  <p>Data sourced from NOAA &amp; Open-Meteo ‚Äî updated daily</p>
  <p style="margin-top:0.5rem"><a href="#">Privacy Policy</a> ¬∑ <a href="#">Contact</a></p>
  <p style="margin-top:0.5rem">¬© 2025 LBITides.com</p>
</footer>

<script>
// ============================================================
// CONFIG
// ============================================================
const NOAA_STATION = '8534720'; // Barnegat Light
const LAT = 39.6515;
const LNG = -74.1945;
const TZ = 'America/New_York';

// ============================================================
// UTILITIES
// ============================================================
function fmt(date) {
  return date.toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric', year:'numeric' });
}

function fmtTime(str) {
  // str like "2025-02-21 06:34"
  const d = new Date(str.replace(' ', 'T'));
  return d.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit', hour12:true });
}

function fmtDay(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('en-US', { weekday:'short' });
}

function degToCompass(deg) {
  const dirs = ['N','NE','E','SE','S','SW','W','NW'];
  return dirs[Math.round(deg / 45) % 8];
}

function getMoonEmoji(phase) {
  if (phase < 0.03 || phase > 0.97) return 'üåë';
  if (phase < 0.22) return 'üåí';
  if (phase < 0.28) return 'üåì';
  if (phase < 0.47) return 'üåî';
  if (phase < 0.53) return 'üåï';
  if (phase < 0.72) return 'üåñ';
  if (phase < 0.78) return 'üåó';
  return 'üåò';
}

function getMoonName(phase) {
  if (phase < 0.03 || phase > 0.97) return 'New Moon';
  if (phase < 0.22) return 'Waxing Crescent';
  if (phase < 0.28) return 'First Quarter';
  if (phase < 0.47) return 'Waxing Gibbous';
  if (phase < 0.53) return 'Full Moon';
  if (phase < 0.72) return 'Waning Gibbous';
  if (phase < 0.78) return 'Last Quarter';
  return 'Waning Crescent';
}

// ============================================================
// DATE
// ============================================================
document.getElementById('current-date').textContent = fmt(new Date());

// ============================================================
// NOAA TIDES
// ============================================================
async function loadTides() {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  const dateStr = `${yyyy}${mm}${dd}`;

  // Hi/Lo
  const hiloUrl = `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?begin_date=${dateStr}&end_date=${dateStr}&station=${NOAA_STATION}&product=predictions&datum=MLLW&time_zone=lst_ldt&interval=hilo&units=english&application=lbitides&format=json`;
  // 6-min for chart
  const chartUrl = `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?begin_date=${dateStr}&end_date=${dateStr}&station=${NOAA_STATION}&product=predictions&datum=MLLW&time_zone=lst_ldt&interval=6&units=english&application=lbitides&format=json`;

  try {
    const [hiloRes, chartRes] = await Promise.all([fetch(hiloUrl), fetch(chartUrl)]);
    const hiloData = await hiloRes.json();
    const chartData = await chartRes.json();

    renderTidePills(hiloData.predictions || []);
    renderTideChart(chartData.predictions || []);
    return hiloData.predictions || [];
  } catch(e) {
    document.getElementById('tidePills').innerHTML = '<p style="color:#888;font-size:0.85rem">Could not load tide data. Check connection.</p>';
    return [];
  }
}

function renderTidePills(predictions) {
  const container = document.getElementById('tidePills');
  if (!predictions.length) { container.innerHTML = '<p style="color:#888">No tide data</p>'; return; }

  container.innerHTML = predictions.map(p => `
    <div class="tide-pill ${p.type === 'L' ? 'low' : ''}">
      <div class="label">${p.type === 'H' ? '‚ñ≤ High Tide' : '‚ñΩ Low Tide'}</div>
      <div class="time">${fmtTime(p.t)}</div>
      <div class="height">${parseFloat(p.v).toFixed(1)} ft</div>
    </div>
  `).join('');
}

function renderTideChart(predictions) {
  const canvas = document.getElementById('tideChart');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth * window.devicePixelRatio;
  canvas.height = 120 * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
  const W = canvas.offsetWidth;
  const H = 120;

  if (!predictions.length) return;

  const values = predictions.map(p => parseFloat(p.v));
  const minV = Math.min(...values);
  const maxV = Math.max(...values);
  const range = maxV - minV || 1;

  const toX = (i) => (i / (values.length - 1)) * W;
  const toY = (v) => H - 12 - ((v - minV) / range) * (H - 24);

  // Gradient fill
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, 'rgba(10,61,92,0.5)');
  grad.addColorStop(1, 'rgba(126,200,227,0.1)');

  ctx.beginPath();
  ctx.moveTo(toX(0), toY(values[0]));
  for (let i = 1; i < values.length; i++) {
    const xc = (toX(i-1) + toX(i)) / 2;
    const yc = (toY(values[i-1]) + toY(values[i])) / 2;
    ctx.quadraticCurveTo(toX(i-1), toY(values[i-1]), xc, yc);
  }
  ctx.lineTo(toX(values.length-1), H);
  ctx.lineTo(toX(0), H);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.moveTo(toX(0), toY(values[0]));
  for (let i = 1; i < values.length; i++) {
    const xc = (toX(i-1) + toX(i)) / 2;
    const yc = (toY(values[i-1]) + toY(values[i])) / 2;
    ctx.quadraticCurveTo(toX(i-1), toY(values[i-1]), xc, yc);
  }
  ctx.strokeStyle = '#0a3d5c';
  ctx.lineWidth = 2;
  ctx.stroke();
}

// ============================================================
// WEATHER + MARINE
// ============================================================
async function loadWeather() {
  const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LNG}&current=temperature_2m,apparent_temperature,wind_speed_10m,wind_direction_10m,uv_index,weather_code&daily=temperature_2m_max,temperature_2m_min,wave_height_max,wave_period_max,wind_speed_10m_max&timezone=${TZ}&forecast_days=7&temperature_unit=fahrenheit&wind_speed_unit=mph`;
  const marineUrl = `https://marine-api.open-meteo.com/v1/marine?latitude=${LAT}&longitude=${LNG}&current=wave_height,wave_direction,wave_period,sea_surface_temperature&daily=wave_height_max,wave_period_max&timezone=${TZ}&forecast_days=7`;

  try {
    const [wRes, mRes] = await Promise.all([fetch(weatherUrl), fetch(marineUrl)]);
    const wData = await wRes.json();
    const mData = await mRes.json();

    renderWeather(wData, mData);
    return { wData, mData };
  } catch(e) {
    document.getElementById('weatherStats').innerHTML = '<p style="color:#888;font-size:0.85rem">Could not load weather data.</p>';
    return null;
  }
}

function renderWeather(w, m) {
  const c = w.current;
  const mc = m.current;
  const waveH = mc?.wave_height ? (mc.wave_height * 3.281).toFixed(1) : '--';
  const wavePer = mc?.wave_period ? mc.wave_period.toFixed(0) : '--';
  const waterTemp = mc?.sea_surface_temperature ? (mc.sea_surface_temperature * 9/5 + 32).toFixed(0) : '--';

  document.getElementById('weatherStats').innerHTML = `
    <div class="stat-block">
      <div class="stat-icon">üå°Ô∏è</div>
      <div class="stat-label">Air Temp</div>
      <div class="stat-value">${c.temperature_2m?.toFixed(0) || '--'}<span class="stat-unit">¬∞F</span></div>
    </div>
    <div class="stat-block">
      <div class="stat-icon">üíß</div>
      <div class="stat-label">Water Temp</div>
      <div class="stat-value">${waterTemp}<span class="stat-unit">¬∞F</span></div>
    </div>
    <div class="stat-block">
      <div class="stat-icon">üåä</div>
      <div class="stat-label">Wave Height</div>
      <div class="stat-value">${waveH}<span class="stat-unit">ft</span></div>
    </div>
    <div class="stat-block">
      <div class="stat-icon">‚è±Ô∏è</div>
      <div class="stat-label">Wave Period</div>
      <div class="stat-value">${wavePer}<span class="stat-unit">s</span></div>
    </div>
    <div class="stat-block">
      <div class="stat-icon">üí®</div>
      <div class="stat-label">Wind</div>
      <div class="stat-value">${c.wind_speed_10m?.toFixed(0) || '--'}<span class="stat-unit">mph ${degToCompass(c.wind_direction_10m)}</span></div>
    </div>
    <div class="stat-block">
      <div class="stat-icon">‚òÄÔ∏è</div>
      <div class="stat-label">UV Index</div>
      <div class="stat-value">${c.uv_index?.toFixed(0) || '--'}</div>
    </div>
  `;

  // 7-day forecast
  renderForecast(w, m);
  return { waveH, waterTemp, wind: c.wind_speed_10m, uv: c.uv_index };
}

function renderForecast(w, m) {
  const daily = w.daily;
  const mDaily = m.daily;
  const days = daily.time || [];

  document.getElementById('forecastRow').innerHTML = days.map((d, i) => {
    const isToday = i === 0;
    const waveH = mDaily?.wave_height_max?.[i] ? (mDaily.wave_height_max[i] * 3.281).toFixed(1) + 'ft' : '--';
    return `
      <div class="forecast-day ${isToday ? 'today' : ''}">
        <div class="day-name">${isToday ? 'Today' : fmtDay(d)}</div>
        <div class="day-high">${daily.temperature_2m_max[i]?.toFixed(0) || '--'}¬∞</div>
        <div class="day-low">${daily.temperature_2m_min[i]?.toFixed(0) || '--'}¬∞</div>
        <div class="day-wave">üåä ${waveH}</div>
      </div>
    `;
  }).join('');
}

// ============================================================
// MOON PHASE
// ============================================================
async function loadMoon() {
  // Calculate moon phase locally (no API needed)
  const moonPhase = calculateMoonPhase(new Date());
  renderMoon(moonPhase);
  return moonPhase;
}

function calculateMoonPhase(date) {
  // Known new moon: Jan 11, 2024
  const knownNewMoon = new Date('2024-01-11T11:57:00Z');
  const lunarCycle = 29.53058770576;
  const daysSince = (date - knownNewMoon) / (1000 * 60 * 60 * 24);
  const phase = ((daysSince % lunarCycle) + lunarCycle) % lunarCycle;
  return phase / lunarCycle; // 0-1
}

function renderMoon(phase) {
  const pct = Math.round(phase * 100);
  const emoji = getMoonEmoji(phase);
  const name = getMoonName(phase);

  // Illumination calc
  const illumination = phase < 0.5
    ? Math.round(phase * 2 * 100)
    : Math.round((1 - phase) * 2 * 100);

  document.getElementById('moonDisplay').innerHTML = `
    <div class="moon-icon">${emoji}</div>
    <div class="moon-info">
      <div class="phase-name">${name}</div>
      <div class="moon-detail">${illumination}% illuminated</div>
    </div>
    <div class="moon-bar-wrap">
      <div class="moon-bar-label">Lunar Cycle Progress</div>
      <div class="moon-bar">
        <div class="moon-bar-fill" style="width:${pct}%"></div>
      </div>
      <div style="font-size:0.65rem;color:var(--muted);margin-top:0.3rem;text-align:right">Day ${Math.round(phase*29.5)} of 29.5</div>
    </div>
  `;
  return { name, illumination, phase };
}

// ============================================================
// SMART SUMMARY
// ============================================================
function buildSummary(tides, weatherData, moonPhase) {
  const tags = [];
  let parts = [];

  // Tides
  if (tides && tides.length) {
    const first = tides[0];
    const firstTime = fmtTime(first.t);
    parts.push(`${first.type === 'H' ? 'High' : 'Low'} tide at ${firstTime}`);
  }

  // Waves
  if (weatherData?.mData?.current?.wave_height) {
    const wh = (weatherData.mData.current.wave_height * 3.281).toFixed(1);
    const wf = parseFloat(wh);
    if (wf < 1) { parts.push('glassy flat ocean'); tags.push('Calm Water'); }
    else if (wf < 2) { parts.push(`${wh}ft waves ‚Äî gentle surf`); tags.push('Easy Surf'); }
    else if (wf < 4) { parts.push(`${wh}ft waves ‚Äî decent surf`); tags.push('Good Surf'); }
    else { parts.push(`${wh}ft waves ‚Äî solid swell`); tags.push('Big Surf'); }
  }

  // Wind
  if (weatherData?.wData?.current?.wind_speed_10m) {
    const ws = weatherData.wData.current.wind_speed_10m;
    if (ws < 10) tags.push('Light Winds');
    else if (ws < 20) tags.push('Moderate Winds');
    else tags.push('Windy');
  }

  // Moon
  if (moonPhase !== null) {
    const name = getMoonName(moonPhase);
    if (name === 'Full Moon' || name === 'New Moon') {
      parts.push(`${name} tonight ‚Äî expect stronger tidal movement`);
      tags.push('Strong Tides');
      tags.push('Good Fishing');
    }
  }

  // UV
  if (weatherData?.wData?.current?.uv_index) {
    const uv = weatherData.wData.current.uv_index;
    if (uv >= 8) tags.push('High UV ‚Äî Sunscreen!');
    else if (uv >= 5) tags.push('Moderate UV');
  }

  if (!parts.length) parts.push('Check the charts below for today\'s full conditions at Long Beach Island');
  if (!tags.length) tags.push('LBI', 'Tides', 'Beach');

  document.getElementById('summaryText').textContent = parts.join(' ¬∑ ') + '.';
  document.getElementById('summaryTags').innerHTML = tags.map(t => `<span class="tag">${t}</span>`).join('');
}

// ============================================================
// FADE IN OBSERVER
// ============================================================
function initFadeIn() {
  const els = document.querySelectorAll('.fade-in');
  const obs = new IntersectionObserver(entries => {
    entries.forEach(e => { if (e.isIntersecting) { e.target.classList.add('visible'); } });
  }, { threshold: 0.1 });
  els.forEach(el => obs.observe(el));
}

// ============================================================
// INIT
// ============================================================
async function init() {
  initFadeIn();
  const [tides, weatherData, moonPhase] = await Promise.all([
    loadTides(),
    loadWeather(),
    loadMoon()
  ]);
  buildSummary(tides, weatherData, moonPhase);
}

init();
</script>

</body>
</html>
