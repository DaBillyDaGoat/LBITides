<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LBI Tides</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Karla:wght@400;500;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

/* â”€â”€ LIGHT MODE (default) â”€â”€ */
:root {
â€“navy:       #1f205c;
â€“sky:        #4d85be;
â€“teal:       #198cac;
â€“red:        #c31d3c;
â€“gold:       #c88000;
â€“gold-vivid: #f0c020;

â€“bg:         #f2ede0;
â€“bg2:        #e8e0cc;
â€“card:       #ffffff;
â€“card2:      #f5f0e8;
â€“border:     rgba(31,32,92,0.1);
â€“text:       #1a1a3a;
â€“text2:      #3a3a5a;
â€“muted:      rgba(31,32,92,0.45);
â€“pill-high:  #1f205c;
â€“pill-low:   #198cac;
â€“pill-text:  #ffffff;
â€“stat-bg:    #1f205c;
â€“stat-text:  #ffffff;
â€“stat-label: rgba(255,255,255,0.5);
â€“sum-bg:     #1f205c;
â€“sum-text:   #ffffff;
â€“link-bg:    #1f205c;
â€“link-hover: #4d85be;
â€“day-bg:     #ffffff;
â€“day-stat:   #1f205c;
â€“section-color: #1f205c;
â€“footer-bg:  #16173f;
â€“footer-text: rgba(255,255,255,0.35);
â€“toggle-bg:  #1f205c;
â€“toggle-ico: #f0c020;
â€“header-bg:  #1f205c;
â€“header-text: #ffffff;
}

/* â”€â”€ DARK MODE â”€â”€ */
[data-theme=â€œdarkâ€] {
â€“bg:         #0e0f2a;
â€“bg2:        #14153a;
â€“card:       #1a1b4b;
â€“card2:      #1f205c;
â€“border:     rgba(255,255,255,0.08);
â€“text:       #e8e8f5;
â€“text2:      #b0b0d0;
â€“muted:      rgba(255,255,255,0.4);
â€“gold:       #f0c020;
â€“gold-vivid: #f5cc30;
â€“pill-high:  #4d85be;
â€“pill-low:   #198cac;
â€“pill-text:  #ffffff;
â€“stat-bg:    #14153a;
â€“stat-text:  #ffffff;
â€“stat-label: rgba(255,255,255,0.4);
â€“sum-bg:     #14153a;
â€“sum-text:   #ffffff;
â€“link-bg:    #1a1b4b;
â€“link-hover: #4d85be;
â€“day-bg:     #1a1b4b;
â€“day-stat:   #14153a;
â€“section-color: #4d85be;
â€“footer-bg:  #080920;
â€“footer-text: rgba(255,255,255,0.25);
â€“toggle-bg:  #f0c020;
â€“toggle-ico: #1f205c;
â€“header-bg:  #080920;
â€“header-text: #ffffff;
}

body {
font-family: â€˜Karlaâ€™, sans-serif;
background: var(â€“bg);
color: var(â€“text);
min-height: 100vh;
transition: background 0.3s, color 0.3s;
}

/* â”€â”€ STORM BANNER â”€â”€ */
#stormBanner {
display: none; position: sticky; top: 0; z-index: 999;
background: var(â€“red); color: #fff;
text-align: center; padding: 0.75rem 3rem;
font-size: 0.8rem; font-weight: 700;
letter-spacing: 0.1em; text-transform: uppercase;
box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
#stormBanner.watch    { background: #a04010; }
#stormBanner.advisory { background: #8a6010; }
.banner-close {
position: absolute; right: 1rem; top: 50%; transform: translateY(-50%);
background: none; border: none; color: #fff; font-size: 1.1rem; cursor: pointer;
}

/* â”€â”€ HEADER â”€â”€ */
header {
background: var(â€“header-bg);
position: relative; overflow: hidden;
}

.flag-sky  { position:absolute; inset:0; background:#4d85be; clip-path:polygon(38% 0,100% 0,100% 100%,38% 100%); z-index:0; }
.flag-teal { position:absolute; inset:0; background:#198cac; clip-path:polygon(38% 100%,100% 100%,100% 50%); z-index:1; }
.flag-red  { position:absolute; top:0; left:0; width:64px; height:64px; background:var(â€“red); z-index:2; }

.header-inner {
position: relative; z-index: 3;
padding: 2.5rem 1.5rem 4rem;
text-align: center;
}

header::after {
content:â€™â€™; position:absolute; bottom:0; left:0; right:0; height:32px;
background: var(â€“bg);
clip-path: polygon(0 100%,100% 100%,100% 30%,80% 0,60% 30%,40% 0,20% 30%,0 0);
z-index: 4;
transition: background 0.3s;
}

/* â”€â”€ THEME TOGGLE â”€â”€ */
.theme-toggle {
position: absolute; top: 1rem; right: 1rem; z-index: 10;
background: var(â€“toggle-bg); color: var(â€“toggle-ico);
border: none; border-radius: 999px;
width: 38px; height: 38px; font-size: 1rem;
cursor: pointer; display: flex; align-items: center; justify-content: center;
box-shadow: 0 2px 8px rgba(0,0,0,0.2);
transition: background 0.3s, color 0.3s;
}

/* â”€â”€ SUN LOGO â”€â”€ */
.sun-logo { display: inline-block; margin-bottom: 0.75rem; }

.site-title {
font-family: â€˜Cormorant Garamondâ€™, serif;
font-size: clamp(3rem, 9vw, 5.5rem);
font-weight: 700; color: #fff; line-height: 0.92;
}

.site-sub {
display: block; font-size: 0.26em; font-weight: 400;
letter-spacing: 0.3em; text-transform: uppercase;
color: rgba(255,255,255,0.5); margin-top: 0.7rem;
}

#current-date {
margin-top: 0.85rem; font-size: 0.68rem; font-weight: 500;
letter-spacing: 0.16em; text-transform: uppercase;
color: rgba(255,255,255,0.4);
}

/* â”€â”€ MAIN â”€â”€ */
main { max-width: 820px; margin: 0 auto; padding: 2rem 1rem 5rem; }

/* â”€â”€ SUMMARY â”€â”€ */
.summary-card {
background: var(â€“sum-bg); border-radius: 14px;
padding: 1.4rem 1.6rem; margin-bottom: 1.1rem;
border-left: 4px solid var(â€“teal);
}
.summary-eyebrow {
font-size: 0.6rem; font-weight: 700;
letter-spacing: 0.26em; text-transform: uppercase;
color: var(â€“gold); margin-bottom: 0.45rem;
}
.summary-text {
font-family: â€˜Cormorant Garamondâ€™, serif;
font-size: 1.2rem; font-weight: 600;
color: var(â€“sum-text); line-height: 1.6;
}
.summary-tags { display:flex; flex-wrap:wrap; gap:0.35rem; margin-top:0.85rem; }
.tag {
background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2);
color: rgba(255,255,255,0.8); border-radius: 999px;
padding: 0.18rem 0.65rem; font-size: 0.62rem; font-weight: 700;
letter-spacing: 0.06em; text-transform: uppercase;
}

/* â”€â”€ SECTION LABEL â”€â”€ */
.section-label {
font-size: 0.6rem; font-weight: 700;
letter-spacing: 0.28em; text-transform: uppercase;
color: var(â€“section-color);
margin: 1.75rem 0 0.7rem;
padding-bottom: 0.38rem;
border-bottom: 2px solid var(â€“section-color);
}

/* â”€â”€ CARD â”€â”€ */
.card {
background: var(â€“card); border-radius: 14px;
padding: 1.25rem 1.3rem; margin-bottom: 1rem;
border: 1px solid var(â€“border);
box-shadow: 0 2px 12px rgba(0,0,0,0.06);
}

/* â”€â”€ TIDE PILLS â”€â”€ */
.tide-pills { display:flex; flex-wrap:wrap; gap:0.55rem; margin-bottom:1rem; }
.tide-pill {
flex:1; min-width:105px; background: var(â€“pill-high);
border-radius:10px; padding:0.8rem 0.85rem; text-align:center;
}
.tide-pill.low { background: var(â€“pill-low); }
.tp-label {
font-size:0.55rem; font-weight:700; letter-spacing:0.16em; text-transform:uppercase;
color:rgba(255,255,255,0.6); margin-bottom:0.2rem;
}
.tp-time { font-family:â€˜Cormorant Garamondâ€™,serif; font-size:1.3rem; font-weight:700; color:#fff; }
.tp-ht   { font-size:0.66rem; font-weight:700; color:rgba(255,255,255,0.5); margin-top:0.1rem; }

/* â”€â”€ TIMELINE â”€â”€ */
.timeline-outer { position:relative; height:54px; margin-bottom:0.4rem; }
.timeline-line {
position:absolute; top:50%; left:0; right:0;
height:2px; background:var(â€“border);
transform:translateY(-50%); border-radius:999px;
}
.t-marker {
position:absolute; top:50%;
transform:translate(-50%,-50%);
display:flex; flex-direction:column; align-items:center;
}
.t-marker.above { flex-direction:column-reverse; }
.t-dot {
width:11px; height:11px; border-radius:50%;
background:var(â€“gold); border:2px solid var(â€“card); flex-shrink:0;
}
.t-marker.low .t-dot { background:var(â€“teal); }
.t-lbl {
font-size:0.53rem; font-weight:700; color:var(â€“text2);
white-space:nowrap; text-align:center; line-height:1.3; margin:3px 0;
}
.timeline-hours {
display:flex; justify-content:space-between;
font-size:0.55rem; font-weight:700;
color:var(â€“muted); letter-spacing:0.04em; padding:0 2px;
}

/* â”€â”€ STATS GRID â”€â”€ */
.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(112px,1fr)); gap:0.55rem; }
.stat-block {
background:var(â€“stat-bg); border-radius:10px;
padding:0.8rem 0.6rem; text-align:center;
border:1px solid var(â€“border);
}
.sb-icon   { font-size:1.2rem; margin-bottom:0.18rem; }
.sb-label  { font-size:0.52rem; font-weight:700; letter-spacing:0.14em; text-transform:uppercase; color:var(â€“stat-label); margin-bottom:0.1rem; }
.sb-value  { font-family:â€˜Cormorant Garamondâ€™,serif; font-size:1.3rem; font-weight:700; color:var(â€“stat-text); line-height:1; }
.sb-unit   { font-size:0.56rem; font-weight:700; color:var(â€“stat-label); }

/* â”€â”€ MOON â”€â”€ */
.moon-row  { display:flex; align-items:center; gap:1.2rem; flex-wrap:wrap; }
.moon-em   { font-size:3rem; line-height:1; }
.moon-info { flex:1; min-width:130px; }
.moon-phase-name { font-family:â€˜Cormorant Garamondâ€™,serif; font-size:1.15rem; font-weight:700; color:var(â€“stat-text); }
.moon-detail     { font-size:0.7rem; font-weight:700; color:var(â€“stat-label); margin-top:0.12rem; }
.moon-bar-wrap   { flex:1.5; min-width:155px; }
.moon-bar-lbl    { font-size:0.52rem; font-weight:700; letter-spacing:0.16em; text-transform:uppercase; color:var(â€“stat-label); margin-bottom:0.35rem; }
.moon-bar        { height:5px; background:var(â€“border); border-radius:999px; overflow:hidden; }
.moon-bar-fill   { height:100%; background:var(â€“sky); border-radius:999px; }
.moon-day-lbl    { font-size:0.56rem; font-weight:700; color:var(â€“muted); text-align:right; margin-top:0.28rem; }

/* â”€â”€ LBI LINKS â”€â”€ */
.links-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(138px,1fr)); gap:0.7rem; }
.link-item {
background:var(â€“link-bg); border-radius:12px; padding:1.1rem 0.85rem;
text-align:center; text-decoration:none; border:1px solid var(â€“border);
transition:background 0.18s, transform 0.15s; display:block;
}
.link-item:hover { background:var(â€“link-hover); transform:translateY(-2px); }
.link-icon { font-size:1.8rem; margin-bottom:0.3rem; }
.link-name { font-family:â€˜Cormorant Garamondâ€™,serif; font-size:0.95rem; font-weight:700; color:#fff; }
.link-sub  { font-size:0.6rem; font-weight:700; color:rgba(255,255,255,0.38); margin-top:0.12rem; }

/* â”€â”€ 7-DAY â”€â”€ */
.forecast-heading {
font-family:â€˜Cormorant Garamondâ€™,serif;
font-size:1.7rem; font-weight:700; color:var(â€“text);
margin:2.25rem 0 1rem; padding-bottom:0.5rem;
border-bottom:3px solid var(â€“section-color);
}

/* â”€â”€ DAY CARD â”€â”€ */
.day-card {
background:var(â€“day-bg); border-radius:14px;
padding:1.05rem 1.2rem 1.15rem; margin-bottom:0.8rem;
border:1px solid var(â€“border);
box-shadow:0 2px 8px rgba(0,0,0,0.05);
}
.day-card.today { border:2px solid var(â€“sky); }
.day-hdr {
display:flex; align-items:baseline; justify-content:space-between;
margin-bottom:0.85rem; padding-bottom:0.5rem;
border-bottom:1px solid var(â€“border);
}
.day-name { font-family:â€˜Cormorant Garamondâ€™,serif; font-size:1.1rem; font-weight:700; color:var(â€“text); }
.day-date { font-size:0.63rem; font-weight:700; color:var(â€“muted); letter-spacing:0.08em; text-transform:uppercase; }
.day-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(82px,1fr)); gap:0.4rem; margin-bottom:0.55rem; }
.day-stat {
background:var(â€“day-stat); border-radius:8px; padding:0.48rem 0.42rem; text-align:center;
border:1px solid var(â€“border);
}
.ds-lbl  { font-size:0.5rem; font-weight:700; letter-spacing:0.13em; text-transform:uppercase; color:rgba(255,255,255,0.38); margin-bottom:0.08rem; }
.ds-val  { font-family:â€˜Cormorant Garamondâ€™,serif; font-size:0.96rem; font-weight:700; color:#fff; line-height:1.1; }
.ds-unit { font-size:0.5rem; font-weight:700; color:rgba(255,255,255,0.3); }
.day-tides { display:flex; flex-wrap:wrap; gap:0.38rem; }
.mini-pill { flex:1; min-width:76px; background:var(â€“pill-high); border-radius:8px; padding:0.42rem 0.48rem; text-align:center; }
.mini-pill.low { background:var(â€“pill-low); }
.mp-lbl  { font-size:0.5rem; font-weight:700; letter-spacing:0.13em; text-transform:uppercase; color:rgba(255,255,255,0.55); }
.mp-time { font-family:â€˜Cormorant Garamondâ€™,serif; font-size:0.95rem; font-weight:700; color:#fff; }
.mp-ht   { font-size:0.54rem; font-weight:700; color:rgba(255,255,255,0.4); }

/* â”€â”€ FOOTER â”€â”€ */
footer {
background:var(â€“footer-bg); color:var(â€“footer-text);
text-align:center; padding:2rem 1rem;
font-size:0.68rem; font-weight:500; letter-spacing:0.08em; line-height:2.2;
}
footer a { color:inherit; text-decoration:none; }

/* â”€â”€ FADE IN â”€â”€ */
.fade-in { opacity:0; transform:translateY(10px); transition:opacity 0.5s ease,transform 0.5s ease; }
.fade-in.visible { opacity:1; transform:translateY(0); }
.loading { color:var(â€“muted); font-size:0.82rem; padding:0.4rem 0; }

/* â”€â”€ SYSTEM PREFERENCE â”€â”€ */
@media (prefers-color-scheme: dark) {
:root:not([data-theme=â€œlightâ€]) {
â€“bg:         #0e0f2a;
â€“bg2:        #14153a;
â€“card:       #1a1b4b;
â€“card2:      #1f205c;
â€“border:     rgba(255,255,255,0.08);
â€“text:       #e8e8f5;
â€“text2:      #b0b0d0;
â€“muted:      rgba(255,255,255,0.4);
â€“gold:       #f0c020;
â€“gold-vivid: #f5cc30;
â€“pill-high:  #4d85be;
â€“pill-low:   #198cac;
â€“stat-bg:    #14153a;
â€“stat-text:  #ffffff;
â€“stat-label: rgba(255,255,255,0.4);
â€“sum-bg:     #14153a;
â€“sum-text:   #ffffff;
â€“link-bg:    #1a1b4b;
â€“link-hover: #4d85be;
â€“day-bg:     #1a1b4b;
â€“day-stat:   #14153a;
â€“section-color: #4d85be;
â€“footer-bg:  #080920;
â€“footer-text: rgba(255,255,255,0.25);
â€“toggle-bg:  #f0c020;
â€“toggle-ico: #1f205c;
â€“header-bg:  #080920;
}
}
</style>

</head>
<body>

<div id="stormBanner">
  <span id="bannerText"></span>
  <button class="banner-close" onclick="this.parentElement.style.display='none'">âœ•</button>
</div>

<header>
  <div class="flag-sky"></div>
  <div class="flag-teal"></div>
  <div class="flag-red"></div>

<button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle light/dark mode">â˜€ï¸</button>

  <div class="header-inner">
    <div class="sun-logo">
      <svg width="68" height="68" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="16" fill="none" stroke="#f0c020" stroke-width="3"/>
        <circle cx="50" cy="50" r="10" fill="none" stroke="#f0c020" stroke-width="2.5"/>
        <circle cx="50" cy="50" r="5"  fill="#f0c020"/>
        <g fill="#f0c020">
          <rect x="47.5" y="4"  width="5" height="14" rx="2.5" transform="rotate(0   50 50)"/>
          <rect x="47.5" y="6"  width="5" height="9"  rx="2.5" transform="rotate(15  50 50)"/>
          <rect x="47.5" y="4"  width="5" height="14" rx="2.5" transform="rotate(30  50 50)"/>
          <rect x="47.5" y="6"  width="5" height="9"  rx="2.5" transform="rotate(45  50 50)"/>
          <rect x="47.5" y="4"  width="5" height="14" rx="2.5" transform="rotate(60  50 50)"/>
          <rect x="47.5" y="6"  width="5" height="9"  rx="2.5" transform="rotate(75  50 50)"/>
          <rect x="47.5" y="4"  width="5" height="14" rx="2.5" transform="rotate(90  50 50)"/>
          <rect x="47.5" y="6"  width="5" height="9"  rx="2.5" transform="rotate(105 50 50)"/>
          <rect x="47.5" y="4"  width="5" height="14" rx="2.5" transform="rotate(120 50 50)"/>
          <rect x="47.5" y="6"  width="5" height="9"  rx="2.5" transform="rotate(135 50 50)"/>
          <rect x="47.5" y="4"  width="5" height="14" rx="2.5" transform="rotate(150 50 50)"/>
          <rect x="47.5" y="6"  width="5" height="9"  rx="2.5" transform="rotate(165 50 50)"/>
          <rect x="47.5" y="4"  width="5" height="14" rx="2.5" transform="rotate(180 50 50)"/>
          <rect x="47.5" y="6"  width="5" height="9"  rx="2.5" transform="rotate(195 50 50)"/>
          <rect x="47.5" y="4"  width="5" height="14" rx="2.5" transform="rotate(210 50 50)"/>
          <rect x="47.5" y="6"  width="5" height="9"  rx="2.5" transform="rotate(225 50 50)"/>
          <rect x="47.5" y="4"  width="5" height="14" rx="2.5" transform="rotate(240 50 50)"/>
          <rect x="47.5" y="6"  width="5" height="9"  rx="2.5" transform="rotate(255 50 50)"/>
          <rect x="47.5" y="4"  width="5" height="14" rx="2.5" transform="rotate(270 50 50)"/>
          <rect x="47.5" y="6"  width="5" height="9"  rx="2.5" transform="rotate(285 50 50)"/>
          <rect x="47.5" y="4"  width="5" height="14" rx="2.5" transform="rotate(300 50 50)"/>
          <rect x="47.5" y="6"  width="5" height="9"  rx="2.5" transform="rotate(315 50 50)"/>
          <rect x="47.5" y="4"  width="5" height="14" rx="2.5" transform="rotate(330 50 50)"/>
          <rect x="47.5" y="6"  width="5" height="9"  rx="2.5" transform="rotate(345 50 50)"/>
        </g>
      </svg>
    </div>
    <div class="site-title">LBI Tides<span class="site-sub">Long Beach Island Â· New Jersey</span></div>
    <div id="current-date">â€”</div>
  </div>
</header>

<main>
  <div class="summary-card fade-in">
    <div class="summary-eyebrow">Today at a Glance</div>
    <div class="summary-text" id="summaryText">Loading conditions...</div>
    <div class="summary-tags" id="summaryTags"></div>
  </div>

  <div class="section-label">ğŸŒŠ Today's Tides â€” Barnegat Light</div>
  <div class="card fade-in">
    <div class="tide-pills" id="tidePills"><div class="loading">Loading...</div></div>
    <div id="tideTimeline"></div>
  </div>

  <div class="section-label">â˜€ï¸ Weather & Ocean</div>
  <div class="card fade-in">
    <div class="stats-grid" id="weatherStats"><div class="loading">Loading...</div></div>
  </div>

  <div class="section-label">ğŸŒ™ Moon Phase</div>
  <div class="card fade-in">
    <div class="moon-row" id="moonDisplay"><div class="loading">Loading...</div></div>
  </div>

  <div class="section-label">ğŸï¸ LBI Essentials</div>
  <div class="links-grid fade-in">
    <a href="https://www.thesandpaper.net" class="link-item" target="_blank">
      <div class="link-icon">ğŸ“°</div><div class="link-name">The Sand Paper</div><div class="link-sub">Local LBI news</div>
    </a>
    <a href="https://ferrarasislandbakery.com" class="link-item" target="_blank">
      <div class="link-icon">ğŸ©</div><div class="link-name">Ferrara's Bakery</div><div class="link-sub">Island baked goods</div>
    </a>
    <a href="https://fantasyislandlbi.com" class="link-item" target="_blank">
      <div class="link-icon">ğŸ¡</div><div class="link-name">Fantasy Island</div><div class="link-sub">Rides & amusements</div>
    </a>
    <a href="https://www.longbeachtownship.com" class="link-item" target="_blank">
      <div class="link-icon">ğŸ›Ÿ</div><div class="link-name">LB Township</div><div class="link-sub">Town info & resources</div>
    </a>
  </div>

  <div class="forecast-heading fade-in">ğŸ“… 7-Day Forecast</div>
  <div id="forecastDays"></div>
</main>

<footer>
  <p>Data: NOAA Tides &amp; Currents Â· Open-Meteo Weather &amp; Marine Â· NWS Alerts</p>
  <p>Est. 2026 Â· Updated automatically each visit</p>
  <p><a href="#">Privacy Policy</a> Â· <a href="#">Contact</a></p>
</footer>

<script>
// â”€â”€ THEME â”€â”€
function getPreferred() {
  const saved = localStorage.getItem('lbi-theme');
  if (saved) return saved;
  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
}
function applyTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  document.getElementById('themeToggle').textContent = t === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
  localStorage.setItem('lbi-theme', t);
}
function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme');
  applyTheme(current === 'dark' ? 'light' : 'dark');
}
applyTheme(getPreferred());

// â”€â”€ CONFIG â”€â”€
const STATION='8534720', LAT=39.6515, LNG=-74.1945, TZ='America/New_York';

const fmtDate    = d => d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
const fmtFullDay = s => new Date(s+'T12:00:00').toLocaleDateString('en-US',{weekday:'long'});
const fmtShortDt = s => new Date(s+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
const fmtTime    = s => new Date(s.replace(' ','T')).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});
const compass    = d => ['N','NE','E','SE','S','SW','W','NW'][Math.round(d/45)%8];
const noaaDate   = (o=0) => { const d=new Date(); d.setDate(d.getDate()+o); return d.toISOString().slice(0,10).replace(/-/g,''); };
const moonEmoji  = p=>{if(p<0.03||p>0.97)return'ğŸŒ‘';if(p<0.22)return'ğŸŒ’';if(p<0.28)return'ğŸŒ“';if(p<0.47)return'ğŸŒ”';if(p<0.53)return'ğŸŒ•';if(p<0.72)return'ğŸŒ–';if(p<0.78)return'ğŸŒ—';return'ğŸŒ˜';};
const moonName   = p=>{if(p<0.03||p>0.97)return'New Moon';if(p<0.22)return'Waxing Crescent';if(p<0.28)return'First Quarter';if(p<0.47)return'Waxing Gibbous';if(p<0.53)return'Full Moon';if(p<0.72)return'Waning Gibbous';if(p<0.78)return'Last Quarter';return'Waning Crescent';};
const moonPhase  = date=>{const k=new Date('2024-01-11T11:57:00Z'),c=29.53058770576;return(((date-k)/86400000%c)+c)%c/c;};

document.getElementById('current-date').textContent = fmtDate(new Date());

async function loadAlerts(){
  try{
    const r=await fetch(`https://api.weather.gov/alerts/active?point=${LAT},${LNG}&status=actual`);
    const d=await r.json();
    const kw=['winter storm','winter weather','blizzard','hurricane','tropical storm','flash flood','coastal flood','high wind','tornado','freeze','ice storm','gale','heavy snow','small craft','dense fog'];
    const hits=(d.features||[]).filter(a=>kw.some(k=>(a.properties.event||'').toLowerCase().includes(k)));
    if(!hits.length)return;
    const p=hits[0].properties,ev=(p.event||'').toLowerCase();
    const b=document.getElementById('stormBanner');
    b.style.display='block';
    if(ev.includes('warning')||p.severity==='extreme')b.className='warning';
    else if(ev.includes('watch'))b.className='watch';
    else b.className='advisory';
    document.getElementById('bannerText').textContent=`âš ï¸ ${p.event}: ${p.headline||(p.description||'').slice(0,100)||'Active alert for LBI'}`;
  }catch(e){}
}

async function loadTides(){
  try{
    const r=await fetch(`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?begin_date=${noaaDate(0)}&end_date=${noaaDate(6)}&station=${STATION}&product=predictions&datum=MLLW&time_zone=lst_ldt&interval=hilo&units=english&application=lbitides&format=json`);
    const d=await r.json();
    const byDate={};
    (d.predictions||[]).forEach(p=>{const k=p.t.slice(0,10);(byDate[k]=byDate[k]||[]).push(p);});
    return{byDate};
  }catch(e){return{byDate:{}};}
}

function renderTodayTides(preds){
  document.getElementById('tidePills').innerHTML=preds.length
    ?preds.map(p=>`<div class="tide-pill ${p.type==='L'?'low':''}"><div class="tp-label">${p.type==='H'?'â–² High':'â–½ Low'}</div><div class="tp-time">${fmtTime(p.t)}</div><div class="tp-ht">${parseFloat(p.v).toFixed(1)} ft</div></div>`).join('')
    :'<div class="loading">No data</div>';
}

function renderTideTimeline(preds){
  if(!preds.length)return;
  const markers=preds.map((p,i)=>{
    const d=new Date(p.t.replace(' ','T'));
    const pct=((d.getHours()+d.getMinutes()/60)/24)*100;
    const above=i%2===0;
    return `<div class="t-marker ${p.type==='L'?'low':'high'} ${above?'above':''}" style="left:${pct}%">
      ${above?`<div class="t-lbl">${fmtTime(p.t)}<br>${parseFloat(p.v).toFixed(1)}ft</div>`:''}
      <div class="t-dot"></div>
      ${!above?`<div class="t-lbl">${fmtTime(p.t)}<br>${parseFloat(p.v).toFixed(1)}ft</div>`:''}
    </div>`;
  }).join('');
  document.getElementById('tideTimeline').innerHTML=`
    <div class="timeline-outer"><div class="timeline-line"></div>${markers}</div>
    <div class="timeline-hours"><span>12am</span><span>6am</span><span>12pm</span><span>6pm</span><span>11pm</span></div>`;
}

async function loadWeather(){
  try{
    const [w,m]=await Promise.all([
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LNG}&current=temperature_2m,wind_speed_10m,wind_direction_10m,uv_index&daily=temperature_2m_max,temperature_2m_min,wind_speed_10m_max&timezone=${TZ}&forecast_days=7&temperature_unit=fahrenheit&wind_speed_unit=mph`).then(r=>r.json()),
      fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${LAT}&longitude=${LNG}&current=wave_height,wave_period,sea_surface_temperature&daily=wave_height_max,wave_period_max,sea_surface_temperature_max&timezone=${TZ}&forecast_days=7`).then(r=>r.json())
    ]);
    return{w,m};
  }catch(e){return null;}
}

function renderTodayWeather(w,m){
  const c=w.current,mc=m.current;
  const wh=mc?.wave_height!=null?(mc.wave_height*3.281).toFixed(1):'--';
  const wp=mc?.wave_period!=null?mc.wave_period.toFixed(0):'--';
  const wt=mc?.sea_surface_temperature!=null?(mc.sea_surface_temperature*9/5+32).toFixed(0):'--';
  document.getElementById('weatherStats').innerHTML=`
    <div class="stat-block"><div class="sb-icon">ğŸŒ¡ï¸</div><div class="sb-label">Air Temp</div><div class="sb-value">${c.temperature_2m?.toFixed(0)||'--'}<span class="sb-unit">Â°F</span></div></div>
    <div class="stat-block"><div class="sb-icon">ğŸ’§</div><div class="sb-label">Water</div><div class="sb-value">${wt}<span class="sb-unit">Â°F</span></div></div>
    <div class="stat-block"><div class="sb-icon">ğŸŒŠ</div><div class="sb-label">Waves</div><div class="sb-value">${wh}<span class="sb-unit">ft</span></div></div>
    <div class="stat-block"><div class="sb-icon">â±ï¸</div><div class="sb-label">Period</div><div class="sb-value">${wp}<span class="sb-unit">s</span></div></div>
    <div class="stat-block"><div class="sb-icon">ğŸ’¨</div><div class="sb-label">Wind</div><div class="sb-value">${c.wind_speed_10m?.toFixed(0)||'--'}<span class="sb-unit">mph ${compass(c.wind_direction_10m||0)}</span></div></div>
    <div class="stat-block"><div class="sb-icon">ğŸ”†</div><div class="sb-label">UV</div><div class="sb-value">${c.uv_index?.toFixed(0)||'--'}</div></div>`;
}

function renderMoon(){
  const phase=moonPhase(new Date()),pct=Math.round(phase*100);
  const illum=phase<0.5?Math.round(phase*2*100):Math.round((1-phase)*2*100);
  document.getElementById('moonDisplay').innerHTML=`
    <div class="moon-em">${moonEmoji(phase)}</div>
    <div class="moon-info"><div class="moon-phase-name">${moonName(phase)}</div><div class="moon-detail">${illum}% illuminated</div></div>
    <div class="moon-bar-wrap">
      <div class="moon-bar-lbl">Lunar Cycle</div>
      <div class="moon-bar"><div class="moon-bar-fill" style="width:${pct}%"></div></div>
      <div class="moon-day-lbl">Day ${Math.round(phase*29.5)} of 29.5</div>
    </div>`;
  return phase;
}

function buildSummary(tides,wData,mData,phase){
  const parts=[],tags=[];
  if(tides?.length){const f=tides[0];parts.push(`${f.type==='H'?'High':'Low'} tide at ${fmtTime(f.t)}`);}
  const mc=mData?.current;
  if(mc?.wave_height!=null){const wh=(mc.wave_height*3.281).toFixed(1),wf=parseFloat(wh);
    if(wf<1){parts.push('glassy flat conditions');tags.push('Calm Water');}
    else if(wf<2){parts.push(`${wh}ft â€” gentle surf`);tags.push('Easy Surf');}
    else if(wf<4){parts.push(`${wh}ft waves`);tags.push('Good Surf');}
    else{parts.push(`${wh}ft â€” solid swell`);tags.push('Big Surf');}
  }
  const wc=wData?.current;
  if(wc?.wind_speed_10m!=null){if(wc.wind_speed_10m<10)tags.push('Light Winds');else if(wc.wind_speed_10m<20)tags.push('Moderate Winds');else tags.push('Windy');}
  const mn=moonName(phase);
  if(mn==='Full Moon'||mn==='New Moon'){parts.push(`${mn} â€” stronger tides tonight`);tags.push('Strong Tides');tags.push('Good Fishing');}
  if(wc?.uv_index>=8)tags.push('High UV â˜€ï¸');else if(wc?.uv_index>=5)tags.push('Moderate UV');
  if(!parts.length)parts.push('Check full conditions below for Long Beach Island');
  if(!tags.length)tags.push('LBI','Tides','Beach');
  document.getElementById('summaryText').textContent=parts.join(' Â· ')+'.';
  document.getElementById('summaryTags').innerHTML=tags.map(t=>`<span class="tag">${t}</span>`).join('');
}

function buildForecast(byDate,w,m){
  const dates=Object.keys(byDate).sort().slice(0,7);
  const wd=w.daily,md=m.daily;
  let html='';
  dates.forEach((dateStr,i)=>{
    const isToday=i===0,tides=byDate[dateStr]||[];
    const phase=moonPhase(new Date(dateStr+'T12:00:00'));
    const hi=wd?.temperature_2m_max?.[i]!=null?wd.temperature_2m_max[i].toFixed(0)+'Â°F':'--';
    const lo=wd?.temperature_2m_min?.[i]!=null?wd.temperature_2m_min[i].toFixed(0)+'Â°F':'--';
    const wh=md?.wave_height_max?.[i]!=null?(md.wave_height_max[i]*3.281).toFixed(1)+'ft':'--';
    const wp=md?.wave_period_max?.[i]!=null?md.wave_period_max[i].toFixed(0)+'s':'--';
    const wt=md?.sea_surface_temperature_max?.[i]!=null?(md.sea_surface_temperature_max[i]*9/5+32).toFixed(0)+'Â°F':'--';
    const wind=wd?.wind_speed_10m_max?.[i]!=null?wd.wind_speed_10m_max[i].toFixed(0)+'mph':'--';
    html+=`<div class="day-card ${isToday?'today':''} fade-in">
      <div class="day-hdr"><div class="day-name">${isToday?'Today':fmtFullDay(dateStr)}</div><div class="day-date">${fmtShortDt(dateStr)}</div></div>
      <div class="day-grid">
        <div class="day-stat"><div class="ds-lbl">High</div><div class="ds-val">${hi}</div></div>
        <div class="day-stat"><div class="ds-lbl">Low</div><div class="ds-val">${lo}</div></div>
        <div class="day-stat"><div class="ds-lbl">Waves</div><div class="ds-val">${wh}</div></div>
        <div class="day-stat"><div class="ds-lbl">Period</div><div class="ds-val">${wp}</div></div>
        <div class="day-stat"><div class="ds-lbl">Water</div><div class="ds-val">${wt}</div></div>
        <div class="day-stat"><div class="ds-lbl">Wind</div><div class="ds-val">${wind}</div></div>
        <div class="day-stat"><div class="ds-lbl">Moon</div><div class="ds-val" style="font-size:1.15rem;line-height:1.2">${moonEmoji(phase)}</div><div class="ds-unit">${moonName(phase).replace(' Moon','')}</div></div>
      </div>
      <div class="day-tides">${tides.map(p=>`<div class="mini-pill ${p.type==='L'?'low':''}"><div class="mp-lbl">${p.type==='H'?'â–² High':'â–½ Low'}</div><div class="mp-time">${fmtTime(p.t)}</div><div class="mp-ht">${parseFloat(p.v).toFixed(1)}ft</div></div>`).join('')}</div>
    </div>`;
  });
  document.getElementById('forecastDays').innerHTML=html;
  document.querySelectorAll('.fade-in:not(.visible)').forEach(el=>observer.observe(el));
}

const observer=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting)e.target.classList.add('visible');});},{threshold:0.06});
document.querySelectorAll('.fade-in').forEach(el=>observer.observe(el));

async function init(){
  document.getElementById('current-date').textContent=fmtDate(new Date());
  const [tideData,weatherData]=await Promise.all([loadTides(),loadWeather()]);
  const todayStr=new Date().toISOString().slice(0,10);
  const todayTides=tideData.byDate[todayStr]||[];
  renderTodayTides(todayTides);
  renderTideTimeline(todayTides);
  if(weatherData)renderTodayWeather(weatherData.w,weatherData.m);
  const phase=renderMoon();
  buildSummary(todayTides,weatherData?.w,weatherData?.m,phase);
  if(weatherData&&Object.keys(tideData.byDate).length)buildForecast(tideData.byDate,weatherData.w,weatherData.m);
  loadAlerts();
}
init();
</script>

</body>
</html>
